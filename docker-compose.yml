services:
  # === MYSQL DATABASE ===
  mysql:
    image: mysql:8.0
    container_name: vetsecure-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: vetsecure
      MYSQL_USER: appuser
      MYSQL_PASSWORD: apppass
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  # === ADMINER for MySQL ===
  adminer:
    image: adminer
    container_name: vetsecure-adminer
    depends_on:
      - mysql
    ports:
      - "8083:8080"

  # === SPRING BOOT BACKEND ===
  backend:
    image: maven:3.9.9-eclipse-temurin-17
    container_name: vetsecure-backend
    depends_on:
      - mysql
    working_dir: /app
    volumes:
      - .:/app
    command: >
      sh -c "mvn clean package -DskipTests &&
             java -jar target/backend-0.0.1-SNAPSHOT.jar"
    ports:
      - "8082:8082"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/vetsecure?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=UTC&characterEncoding=utf8
      SPRING_DATASOURCE_USERNAME: appuser
      SPRING_DATASOURCE_PASSWORD: apppass
      SPRING_PROFILES_ACTIVE: default,google
      SPRING_FLYWAY_ENABLED: "false"
      # Google OAuth2 Configuration
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      APP_OAUTH2_REDIRECT_URI: "http://localhost:8080/login"
#      SPRING_FLYWAY_LOCATIONS: classpath:db/migration
#      SPRING_FLYWAY_VALIDATE_ON_MIGRATE: "true"
#      SPRING_FLYWAY_BASELINE_ON_MIGRATE: "true"

  # === REACT FRONTEND ===
  frontend:
    image: node:24-alpine
    container_name: vetsecure-frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
    command: sh -c "npm install && npm start"
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - REACT_APP_API_BASE=http://localhost:8082
      # Enable reliable hot reload when running in Docker/Windows
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
      - WDS_SOCKET_PORT=0
    depends_on:
      - backend
    stdin_open: true
    tty: true

volumes:
  mysql_data:
